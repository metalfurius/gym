name: Build iOS

on:
  push:
    branches: [master]
    paths:
      - 'ios/**'
      - 'js/**'
      - 'css/**'
      - 'index.html'
      - 'manifest.json'
      - 'capacitor.config.ts'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/build-ios.yml'
  pull_request:
    branches: [master]
    paths:
      - 'ios/**'
      - 'js/**'
      - 'css/**'
      - 'index.html'
      - 'manifest.json'
      - 'capacitor.config.ts'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/build-ios.yml'
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read

jobs:
  build-ios:
    name: Build Debug App
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Select Xcode version
        run: |
          # Use the latest stable Xcode available on the runner
          # List available Xcode versions for debugging
          ls -la /Applications/ | grep Xcode || true
          
          # Try to use Xcode 16.x if available, otherwise fall back to default
          if [ -d "/Applications/Xcode_16.2.app" ]; then
            sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
          elif [ -d "/Applications/Xcode_16.1.app" ]; then
            sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
          elif [ -d "/Applications/Xcode_16.0.app" ]; then
            sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer
          elif [ -d "/Applications/Xcode_15.4.app" ]; then
            sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer
          elif [ -d "/Applications/Xcode.app" ]; then
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          else
            echo "Using default Xcode version"
          fi
          xcodebuild -version

      # Diagnostic step: useful for troubleshooting Xcode/Simulator issues in CI.
      - name: List available simulators
        run: |
          echo "Available iOS Simulator devices:"
          xcrun simctl list devices available | grep -i ios | head -30

      - name: Install dependencies
        run: npm ci

      - name: Build web assets
        run: npm run build:web

      - name: Sync Capacitor
        run: npx cap sync ios

      - name: Install CocoaPods dependencies
        working-directory: ios/App
        run: pod install

      - name: Build debug app
        working-directory: ios/App
        run: |
          # Get first available iPhone simulator
          SIMULATOR=$(xcrun simctl list devices available | grep "iPhone" | head -1 | grep -oE '[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}')
          
          # Validate that a simulator was found
          if [ -z "$SIMULATOR" ]; then
            echo "Error: No iPhone simulator found"
            echo "Available simulators:"
            xcrun simctl list devices available
            exit 1
          fi
          
          echo "Building for simulator: $SIMULATOR"
          
          # Build for iOS Simulator (no code signing required)
          set -o pipefail
          xcodebuild \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination "platform=iOS Simulator,id=$SIMULATOR" \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            build 2>&1 | tee build.log
          
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "=========================================="
            echo "BUILD FAILED - Last 100 lines of log:"
            echo "=========================================="
            tail -100 build.log
            exit $BUILD_EXIT_CODE
          fi

      - name: Get version
        id: version
        run: |
          VERSION=$(node -p "require('./manifest.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create app archive
        working-directory: ios/App
        run: |
          cd build/Build/Products/Debug-iphonesimulator
          zip -r App.zip App.app

      - name: Upload debug iOS simulator app
        uses: actions/upload-artifact@v4
        with:
          name: my-workout-tracker-v${{ steps.version.outputs.version }}-debug-ios-simulator
          path: ios/App/build/Build/Products/Debug-iphonesimulator/App.zip
          if-no-files-found: error
