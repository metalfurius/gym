<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Sistema de Versioning - Gym Tracker</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .log {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Test del Sistema de Versioning</h1>
    <p>Esta p√°gina te permite probar el sistema de versioning de Gym Tracker sin afectar la aplicaci√≥n principal.</p>

    <div class="test-section">
        <h2>üìã Estado Actual del Sistema</h2>
        <p><strong>Versi√≥n almacenada:</strong> <span id="stored-version">Cargando...</span></p>
        <p><strong>Versi√≥n actual:</strong> <span id="current-version">1.0.2</span></p>
        <p><strong>Service Worker:</strong> <span id="sw-status">Verificando...</span></p>
        <p><strong>Cach√© disponible:</strong> <span id="cache-status">Verificando...</span></p>
    </div>

    <div class="test-section">
        <h2>üîß Pruebas del Sistema</h2>
        <button class="button" onclick="testVersionDetection()">Probar Detecci√≥n de Versi√≥n</button>
        <button class="button" onclick="testCacheManagement()">Probar Gesti√≥n de Cach√©</button>
        <button class="button" onclick="testSessionBackup()">Probar Backup de Sesi√≥n</button>
        <button class="button" onclick="simulateUpdate()">Simular Actualizaci√≥n</button>
        <button class="button" onclick="resetSystem()">Resetear Sistema</button>
    </div>

    <div class="test-section">
        <h2>üìä Log de Pruebas</h2>
        <div id="test-log" class="log">Iniciando sistema de pruebas...\n</div>
        <button class="button" onclick="clearLog()">Limpiar Log</button>
    </div>

    <div class="test-section warning">
        <h2>‚ö†Ô∏è Advertencias</h2>
        <ul>
            <li>Este test modifica localStorage temporalmente</li>
            <li>Los cambios no afectan la aplicaci√≥n principal</li>
            <li>Puedes resetear todo con el bot√≥n "Resetear Sistema"</li>
        </ul>
    </div>

    <script>
        // Simulaci√≥n del sistema de versioning para pruebas
        const TEST_VERSION_KEY = 'gym-tracker-version-test';
        const TEST_BACKUP_KEY = 'gym-tracker-backup-session-test';
        const CURRENT_VERSION = '1.0.2';

        function log(message) {
            const logEl = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateStatus() {
            const storedVersion = localStorage.getItem(TEST_VERSION_KEY) || 'No establecida';
            document.getElementById('stored-version').textContent = storedVersion;

            // Check Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    document.getElementById('sw-status').textContent = 
                        registrations.length > 0 ? 'Activo' : 'No registrado';
                });
            } else {
                document.getElementById('sw-status').textContent = 'No soportado';
            }

            // Check Cache API
            if ('caches' in window) {
                caches.keys().then(cacheNames => {
                    const gymCaches = cacheNames.filter(name => name.startsWith('gym-tracker-'));
                    document.getElementById('cache-status').textContent = 
                        `${gymCaches.length} cach√©s encontrados`;
                });
            } else {
                document.getElementById('cache-status').textContent = 'No soportado';
            }
        }

        function testVersionDetection() {
            log('üîç Iniciando prueba de detecci√≥n de versi√≥n...');
            
            const storedVersion = localStorage.getItem(TEST_VERSION_KEY);
            
            if (!storedVersion) {
                log('‚úÖ Primera instalaci√≥n detectada correctamente');
                localStorage.setItem(TEST_VERSION_KEY, CURRENT_VERSION);
                log(`üì¶ Versi√≥n ${CURRENT_VERSION} establecida en localStorage`);
            } else if (storedVersion !== CURRENT_VERSION) {
                log(`üîÑ Actualizaci√≥n detectada: ${storedVersion} ‚Üí ${CURRENT_VERSION}`);
                localStorage.setItem(TEST_VERSION_KEY, CURRENT_VERSION);
                log('‚úÖ Versi√≥n actualizada en localStorage');
            } else {
                log('‚ÑπÔ∏è Sin cambios de versi√≥n detectados');
            }
            
            updateStatus();
        }

        function testCacheManagement() {
            log('üóÑÔ∏è Iniciando prueba de gesti√≥n de cach√©...');
            
            if ('caches' in window) {
                caches.keys().then(cacheNames => {
                    const gymCaches = cacheNames.filter(name => name.startsWith('gym-tracker-'));
                    log(`üìä Encontrados ${gymCaches.length} cach√©s de Gym Tracker`);
                    
                    gymCaches.forEach(cacheName => {
                        log(`   - ${cacheName}`);
                    });
                    
                    if (gymCaches.length > 1) {
                        log('‚ö†Ô∏è M√∫ltiples cach√©s detectados - ser√≠a necesario limpiar los antiguos');
                    } else {
                        log('‚úÖ Gesti√≥n de cach√© correcta');
                    }
                });
            } else {
                log('‚ùå Cache API no soportada en este navegador');
            }
        }

        function testSessionBackup() {
            log('üíæ Iniciando prueba de backup de sesi√≥n...');
            
            // Simular una sesi√≥n en progreso
            const mockSession = {
                routineId: 'test-routine-123',
                data: {
                    ejercicios: [
                        { nombreEjercicio: 'Test Exercise', sets: [{ peso: 50, reps: 10 }] }
                    ],
                    pesoUsuario: 75
                }
            };
            
            // Simular backup
            localStorage.setItem(TEST_BACKUP_KEY, JSON.stringify(mockSession));
            log('‚úÖ Sesi√≥n respaldada exitosamente');
            
            // Verificar backup
            const restoredSession = localStorage.getItem(TEST_BACKUP_KEY);
            if (restoredSession) {
                const parsed = JSON.parse(restoredSession);
                log(`üìã Backup verificado: rutina ${parsed.routineId}, ${parsed.data.ejercicios.length} ejercicio(s)`);
                log('‚úÖ Sistema de backup funcionando correctamente');
            } else {
                log('‚ùå Error: No se pudo verificar el backup');
            }
        }

        function simulateUpdate() {
            log('üöÄ Simulando proceso completo de actualizaci√≥n...');
            
            // 1. Simular versi√≥n anterior
            const oldVersion = '1.0.1';
            localStorage.setItem(TEST_VERSION_KEY, oldVersion);
            log(`üìù Versi√≥n anterior simulada: ${oldVersion}`);
            
            // 2. Simular sesi√≥n en progreso
            const mockSession = {
                routineId: 'active-routine',
                data: { ejercicios: [], pesoUsuario: 70 }
            };
            localStorage.setItem(TEST_BACKUP_KEY, JSON.stringify(mockSession));
            log('üíæ Sesi√≥n en progreso respaldada');
            
            // 3. Simular detecci√≥n de actualizaci√≥n
            setTimeout(() => {
                log(`üîÑ Actualizaci√≥n detectada: ${oldVersion} ‚Üí ${CURRENT_VERSION}`);
                
                // 4. Simular limpieza de cach√©
                log('üóëÔ∏è Limpiando cach√©s antiguos...');
                
                // 5. Actualizar versi√≥n
                localStorage.setItem(TEST_VERSION_KEY, CURRENT_VERSION);
                log(`‚úÖ Versi√≥n actualizada a ${CURRENT_VERSION}`);
                
                // 6. Restaurar sesi√≥n
                const backupSession = localStorage.getItem(TEST_BACKUP_KEY);
                if (backupSession) {
                    log('üîÑ Restaurando sesi√≥n en progreso...');
                    log('‚úÖ Sesi√≥n restaurada exitosamente');
                    localStorage.removeItem(TEST_BACKUP_KEY);
                }
                
                log('üéâ Proceso de actualizaci√≥n completado exitosamente');
                updateStatus();
                
                // Simular notificaci√≥n
                showTestNotification();
            }, 1000);
        }

        function showTestNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #27ae60, #2ecc71);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-family: inherit;
                animation: slideIn 0.5s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="margin-bottom: 8px;">
                    <strong>üéâ ¬°Actualizaci√≥n Simulada!</strong>
                </div>
                <div style="font-size: 0.9em; opacity: 0.9;">
                    Versi√≥n ${CURRENT_VERSION} - Sistema funcionando
                </div>
            `;
            
            // A√±adir animaci√≥n CSS
            if (!document.querySelector('#test-notification-styles')) {
                const styles = document.createElement('style');
                styles.id = 'test-notification-styles';
                styles.textContent = `
                    @keyframes slideIn {
                        from { opacity: 0; transform: translateX(100%); }
                        to { opacity: 1; transform: translateX(0); }
                    }
                `;
                document.head.appendChild(styles);
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
            
            log('üì¢ Notificaci√≥n de actualizaci√≥n mostrada');
        }

        function resetSystem() {
            log('üîÑ Reseteando sistema de pruebas...');
            localStorage.removeItem(TEST_VERSION_KEY);
            localStorage.removeItem(TEST_BACKUP_KEY);
            log('‚úÖ Sistema reseteado - todas las claves de prueba eliminadas');
            updateStatus();
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = 'Log limpiado...\n';
        }

        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            log('üé¨ Sistema de pruebas iniciado');
            log(`üì± User Agent: ${navigator.userAgent.substring(0, 50)}...`);
            log(`üíæ localStorage disponible: ${typeof(Storage) !== "undefined" ? 'S√≠' : 'No'}`);
            log(`üóÑÔ∏è Cache API disponible: ${'caches' in window ? 'S√≠' : 'No'}`);
            log(`üë∑ Service Worker disponible: ${'serviceWorker' in navigator ? 'S√≠' : 'No'}`);
            updateStatus();
        });
    </script>
</body>
</html>
